<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homepage</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Genel Sayfa Ayarları */
        body {
            font-family: Arial, sans-serif;
        }

        /* Kart Tasarımı */
        #customer-details-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        #customer-details-card .card-header {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            text-align: center;
        }
        #customer-details-content {
            color: #495057;
        }

        /* Tablolar için Boş Veriyi Gösterme */
        .table tbody tr {
            background-color: #f8f9fa;
        }
        .table th {
            background-color: #007bff;
            color: white;
        }
        .table td {
            vertical-align: middle;
            text-align: center;
            color: #6c757d;
        }

        /* Sekme Başlıkları */
        .nav-tabs .nav-link.active {
            background-color: #007bff;
            color: white;
        }
        .nav-tabs .nav-link {
            color: #007bff;
        }
        .nav-tabs .nav-link:hover {
            color: #0056b3;
        }

        /* Statik Veri Görünümü */
        .table-placeholder {
            color: #6c757d;
            text-align: center;
            font-style: italic;
            opacity: 0.8;
        }

        /* Sidebar Stil Ayarları */
        .sidebar {
            height: 100vh;
            width: 250px;
            position: fixed;
            top: 0;
            left: 0;
            background-color: #343a40;
            padding-top: 60px;
            z-index: 1;
        }
        .sidebar .nav-link {
            color: #adb5bd;
            font-weight: 500;
        }
        .sidebar .nav-link:hover {
            color: #ffffff;
        }
        .sidebar .active {
            color: #ffffff;
            background-color: #007bff;
        }

        /* Ana içerik alanı ayarları */
        .content {
            margin-left: 270px; /* İçerik alanını sidebar genişliği kadar sağa kaydır */
            padding: 20px;
        }

        /* Küçük ekranlarda sidebar'ın üstte navbar kadar küçültülmesi */
        @media (max-width: 992px) {
            .sidebar {
                height: 60px; /* Navbar ile aynı yükseklik */
                width: 100%; /* Ekran genişliği kadar */
                padding-top: 0;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .sidebar .nav-link {
                display: inline-block;
                padding: 0.5rem 1rem;
            }
            .sidebar .nav-item {
                display: inline;
            }
            .content {
                margin-left: 0;
            }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8); /* Siyah renkle biraz karartma */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-light">
    <div id="loading" class="loading-overlay" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Yükleniyor...</span>
        </div>
    </div>    

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">DGN</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <input type="text" id="customer_code" class="form-control" placeholder="Müşteri Kodu">
                    </li>
                    <li class="nav-item">
                        <button class="btn btn-light ms-2" onclick="fetchCustomerDetails()">ARA</button>
                    </li>
                    <!-- Dropdown Kullanıcı Menü -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            {{ username }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="/logout">Çıkış Yap</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Sidebar Menü -->
    <div class="sidebar d-none d-lg-block" id="sidebarMenu">
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link active" href="/homepage/">
                    <i class="bi bi-house-door-fill me-2"></i>Ana Sayfa
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="fetchCustomerDetailsAndRedirect()">
                    <i class="bi bi-person-lines-fill me-2"></i>Müşteri Detayları
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">
                    <i class="bi bi-gear-fill me-2"></i>Ayarlar
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/logout">
                    <i class="bi bi-box-arrow-right me-2"></i>Çıkış Yap
                </a>
            </li>
        </ul>
    </div>

    <!-- Ana İçerik -->
    <div class="content">
        <div class="row">
            <!-- Sol Sütun - Müşteri Detayları Kartı -->
            <div class="col-md-6">
                <div class="card mb-4" id="customer-details-card">
                    <div class="card-header">
                        Müşteri Detayları
                    </div>            
                    <div class="card-body">
                        <div id="customer-details-content">
                            <p class="text-center table-placeholder">Veri bekleniyor...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sağ Sütun - Telefonlar Tablosu -->
            <div class="col-md-6">
                <div class="table-responsive">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2>Telefon Numaraları</h2>
                        <button id="addPhoneButton" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addPhoneModal" disabled>
                            Ekle
                        </button>
                    </div>
                    <table class="table table-sm table-bordered mt-3" id="customer-phones-table">
                        <thead>
                            <tr>
                                <th>İletişim Türü</th>
                                <th>Telefon Numarası</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="2" class="table-placeholder">Veri bekleniyor...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Telefon Ekleme Modal -->
            <div class="modal fade" id="addPhoneModal" tabindex="-1" aria-labelledby="addPhoneModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addPhoneModalLabel">Yeni Telefon Numarası Ekle</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addPhoneForm">
                                <div class="mb-3">
                                    <label for="communicationType" class="form-label">İletişim Türü</label>
                                    <select id="communicationType" class="form-select" required>
                                        <option value="">Seçiniz...</option>
                                        <option value="001">Kendi Cep Telefonu</option>
                                        <option value="002">Ulaşılmasını İstediği 2. Cep Numarası</option>
                                        <option value="003">İş Telefonu</option>
                                        <option value="004">Ev Telefonu</option>
                                        <option value="005">E-Mail</option>
                                        <option value="006">Ek Kullanıcı 1 Cep Tel</option>
                                        <option value="007">Ek Kullanıcı 2 Cep Tel</option>
                                        <option value="008">Ek Kullanıcı 3 Cep Tel</option>
                                        <option value="009">KASİYER DENEME GİRECEĞİ TEL</option>
                                        <option value="010">Baba Telefonu</option>
                                        <option value="011">Anne telefonu</option>
                                        <option value="012">Eşinin Telefonu</option>
                                        <option value="013">Arkadaş Telefonu</option>
                                        <option value="014">Kardeş ( aile bireyi )</option>
                                        <option value="015">İsimli Tel. Alma</option>
                                        <option value="016">Kızı</option>
                                        <option value="017">Oğlu</option>
                                        <option value="018">Yakın akrabası</option>
                                        <option value="019">Tanıdığı</option>
                                        <option value="020">Kullanım Dışı</option>
                                        <option value="021">Başkası Tarafından Kullanılıyor</option>
                                        <option value="022">Güncel Olabilecek Telefonu</option>
                                        <option value="023">Yeni Güncel Güncel Telefonu Olabilir</option>
                                        <option value="024">AVUKATA GELEN KENDİ TEFON NUMARASI</option>
                                        <option value="025">AVUKATA GELEN AKRABA VE YAKINI Telefon numarası</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="phoneNumber" class="form-label">Telefon Numarası</label>
                                    <input type="text" id="phoneNumber" class="form-control" placeholder="Telefon numarası giriniz" required>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                            <button type="submit" form="addPhoneForm" class="btn btn-primary">Ekle</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sekmeler -->
        <ul class="nav nav-tabs mt-4" id="customerTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link active" id="notes-tab" data-bs-toggle="tab" href="#notes" role="tab" aria-controls="notes" aria-selected="true">Not 1</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="notes2-tab" data-bs-toggle="tab" href="#notes2" role="tab" aria-controls="notes2" aria-selected="false">Not 2</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="attributes-tab" data-bs-toggle="tab" href="#attributes" role="tab" aria-controls="attributes" aria-selected="false">Müşteri Özellikleri</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="messages-tab" data-bs-toggle="tab" href="#messages" role="tab" aria-controls="messages" aria-selected="false">Mesajlar</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="addresses-tab" data-bs-toggle="tab" href="#addresses" role="tab" aria-controls="addresses" aria-selected="false">Adresler</a>
            </li>
        </ul>

        <!-- Sekme İçerikleri -->
        <div class="tab-content mt-3" id="customerTabsContent">
            <!-- Müşteri Notları 1 -->
            <div class="tab-pane fade show active" id="notes" role="tabpanel" aria-labelledby="notes-tab">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered" id="customer-notes-table">
                        <thead>
                            <tr>
                                <th>Not</th>
                                <th>Uyarı Türü</th>
                                <th>Tarih</th>
                                <th>Notu Alan</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="4" class="table-placeholder">Veri bekleniyor...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Müşteri Notları 2 -->
            <div class="tab-pane fade" id="notes2" role="tabpanel" aria-labelledby="notes2-tab">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered" id="customer-notes2-table">
                        <thead>
                            <tr>
                                <th>Not</th>
                                <th>Tarih</th>
                                <th>Notu Alan</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="3" class="table-placeholder">Veri bekleniyor...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Müşteri Özellikleri -->
            <div class="tab-pane fade" id="attributes" role="tabpanel" aria-labelledby="attributes-tab">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered" id="customer-attributes-table">
                        <thead>
                            <tr>
                                <th>Özellik Açıklaması</th>
                                <th>Detay</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="3" class="table-placeholder">Veri bekleniyor...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Müşteri Mesajları -->
            <div class="tab-pane fade" id="messages" role="tabpanel" aria-labelledby="messages-tab">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered" id="customer-messages-table">
                        <thead>
                            <tr>
                                <th>Telefon Numarası</th>
                                <th>Tarih</th>
                                <th>Mesaj</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="3" class="table-placeholder">Veri bekleniyor...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Adresler -->
            <div class="tab-pane fade" id="addresses" role="tabpanel" aria-labelledby="addresses-tab">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered" id="customer-addresses-table">
                        <thead>
                            <tr>
                                <th>Adres Türü</th>
                                <th>Adres</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="2" class="table-placeholder">Veri bekleniyor...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // URL'den customerCode parametresini alın
            const urlParams = new URLSearchParams(window.location.search);
            const customerCode = urlParams.get("customerCode");

            // Eğer customerCode mevcutsa fetchCustomerDetails fonksiyonunu çağır
            if (customerCode) {
                document.getElementById("customer_code").value = customerCode;  // input alanına müşteri kodunu gir
                fetchCustomerDetails();  // Fonksiyonu çağır
            }
        });

        function showLoading() {
            document.getElementById("loading").style.display = "flex";
        }

        function hideLoading() {
            document.getElementById("loading").style.display = "none";
        }


        function fetchCustomerDetails() {
            const customerCode = document.getElementById("customer_code").value;

            // Eğer müşteri kodu boşsa uyarı ver
            if (!customerCode) {
                alert("Lütfen müşteri kodunu girin.");
                return;
            }
            
            showLoading();

            fetch(`/fetch-customer-details/${customerCode}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('API çağrısı başarısız.');
                    }
                    return response.json();
                })
                .then(data => {
                    const userName = "{{ username }}"; // Django'dan gelen kullanıcı adı
                    updateCustomerDetailsCard(data.customer_details[0] || {});
                    updateCustomerPhonesTable(data.customer_phones || []);
                    updateCustomerNotesTable1(data.customer_notes1 || []);
                    updateCustomerNotesTable2(data.customer_notes2 || []);
                    updateCustomerAttributesTable(data.customer_attributes || []);
                    updateCustomerMessagesTable(data.customer_messages || []);
                    updateCustomerAddressesTable(data.customer_addresses || []);

                    // Telefon Ekle butonunu aktif hale getir
                    document.getElementById("addPhoneButton").disabled = false;

                })
                .catch(error => {
                    alert(`Hata: ${error.message}`);
                })
                .finally(() => {
                    hideLoading(); // İşlem tamamlanınca animasyonu gizle
                });
        }

        // Telefon ekleme butonunu başlangıçta devre dışı bırak
        document.addEventListener("DOMContentLoaded", function() {
        document.getElementById("addPhoneButton").disabled = true;
        });

        function updateCustomerDetailsCard(details) {
            const content = document.getElementById("customer-details-content");
            content.innerHTML = `
                <ul class="list-group list-group-flush">
                    <li class="list-group-item"><strong>Ad:</strong> ${details.Name || 'Bilgi yok'}</li>
                    <li class="list-group-item"><strong>Soyad:</strong> ${details.Surname || 'Bilgi yok'}</li>
                    <li class="list-group-item"><strong>Kimlik No:</strong> ${details.IdentityNum || 'Bilgi yok'}</li>
                    <li class="list-group-item"><strong>Baba Adı:</strong> ${details.FatherName || 'Bilgi yok'}</li>
                    <li class="list-group-item"><strong>Anne Adı:</strong> ${details.MotherName || 'Bilgi yok'}</li>
                    <li class="list-group-item"><strong>Hesap Açılış Tarihi:</strong> ${new Date(parseInt(details.AccountOpeningDate.replace(/[^0-9]/g, ''))).toLocaleDateString() || 'Bilgi yok'}</li>
                    <li class="list-group-item"><strong>Toplam Borç:</strong> ${details.TotalOverdueDebt || 'Bilgi yok'}</li>
                    <li class="list-group-item"><strong>Kredi Limiti:</strong> ${details.CreditLimit || 'Bilgi yok'}</li>
                    <li class="list-group-item"><strong>Kalan Limit:</strong> ${details.RemainingLimit || 'Bilgi yok'}</li>
                    <li class="list-group-item"><strong>Kötü Borç:</strong> ${details.BadDebt || 'Bilgi yok'}</li>
                </ul>
            `;
        }

        function updateCustomerPhonesTable(phones) {
            const tableBody = document.querySelector("#customer-phones-table tbody");
            tableBody.innerHTML = phones.map(phone => `
                <tr>
                    <td>${phone.CommunicationTypeDescription}</td>
                    <td>${phone.Phone}</td>
                </tr>
            `).join('');
        }

        function updateCustomerNotesTable1(customer_notes1) {
            const tableBody = document.querySelector("#customer-notes-table tbody");
            tableBody.innerHTML = customer_notes1.map(note => `
                <tr>
                    <td>${note.DescriptionNote1 || 'Bilgi yok'}</td>
                    <td>${note.AlertTypeNote1 || 'Bilgi yok'}</td>
                    <td>${new Date(parseInt(note.DateNote1.replace(/[^0-9]/g, ''))).toLocaleDateString() || 'Bilgi yok'}</td>
                    <td>${note.NoteTakerNote1 || 'Bilgi yok'}</td>
                </tr>
            `).join('');
        }

        function updateCustomerNotesTable2(customer_notes2) {
            const tableBody = document.querySelector("#customer-notes2-table tbody");
            tableBody.innerHTML = customer_notes2.map(note => `
                <tr>
                    <td>${note.DescriptionNote2 || 'Bilgi yok'}</td>
                    <td>${new Date(parseInt(note.DateNote2.replace(/[^0-9]/g, ''))).toLocaleDateString() || 'Bilgi yok'}</td>
                    <td>${note.NoteTakerNote2 || 'Bilgi yok'}</td>
                </tr>
            `).join('');
        }

        function updateCustomerAttributesTable(customer_attributes, customerCode, userName) {
            const tableBody = document.querySelector("#customer-attributes-table tbody");
            tableBody.innerHTML = customer_attributes.map(attr => `
                <tr>
                    <td>${attr.AttributeTypeDescription || 'Bilgi yok'}</td>
                    <td id="dropdown-${attr.AttributeTypeCode}">
                        ${attr.AttributeDescription ? attr.AttributeDescription : '<span class="table-placeholder">Seçim bekleniyor...</span>'}
                    </td>
                </tr>
            `).join('');

            customer_attributes.forEach(attr => {
                fetchAttributeDescriptionList(attr.AttributeTypeCode, customerCode, userName);
            });
        }

        function updateCustomerMessagesTable(customer_messages) {
            const tableBody = document.querySelector("#customer-messages-table tbody");
            tableBody.innerHTML = customer_messages.map(msg => `
                <tr>
                    <td>${msg.TelephoneNumMessage || 'Bilgi yok'}</td>
                    <td>${new Date(parseInt(msg.DateMessage.replace(/[^0-9]/g, ''))).toLocaleDateString() || 'Bilgi yok'}</td>
                    <td>${msg.Message || 'Bilgi yok'}</td>
                </tr>
            `).join('');
        }

        function updateCustomerAddressesTable(customer_addresses) {
            const tableBody = document.querySelector("#customer-addresses-table tbody");
            tableBody.innerHTML = customer_addresses.map(addr => `
                <tr>
                    <td>${addr.AdressType || 'Bilgi yok'}</td>
                    <td>${addr.Adress || 'Bilgi yok'}</td>
                </tr>
            `).join('');
        }
    </script>

    <!-- JavaScript ile Modal İşlevselliği ve API Entegrasyonu -->
    <script>
        document.getElementById("addPhoneForm").addEventListener("submit", function(event) {
            event.preventDefault();
            
            const communicationType = document.getElementById("communicationType").value;
            const phoneNumber = document.getElementById("phoneNumber").value;

            // Kullanıcının müşteri kodu ve adını al
            const customerCode = document.getElementById("customer_code").value;
            const username = "{{ username }}"; // Django'dan gelen kullanıcı adı

            // API'ye gönderilecek veriyi oluştur
            const requestData = {
                "CustomerCode": customerCode,
                "CommunicationTypeCode": communicationType,
                "CommAddress": phoneNumber,
                "UserName": username
            };

            fetch('/api/add-customer-communication/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}' // Django CSRF koruması için token ekleyin
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Telefon numarası eklenemedi.');
                }
                return response.json();
            })
            .then(data => {
                alert('Telefon numarası başarıyla eklendi!');
                
                // Telefon numarası eklenince tabloyu güncelleyin
                const tableBody = document.querySelector("#customer-phones-table tbody");
                tableBody.insertAdjacentHTML('beforeend', `
                    <tr>
                        <td>${communicationType}</td>
                        <td>${phoneNumber}</td>
                    </tr>
                `);

                // Modal'ı kapat ve formu sıfırla
                const modal = new bootstrap.Modal(document.getElementById("addPhoneModal"));
                modal.hide();
                document.getElementById("addPhoneForm").reset();
            })
            .catch(error => {
                alert(`Hata: ${error.message}`);
            });
        });
    </script>

    <script>
        function fetchCustomerDetailsAndRedirect() {
            showLoading(); // Yükleniyor animasyonunu göster

            fetch('/api/customer-search/')
                .then(response => {
                    console.log("Response status:", response.status);  // HTTP durum kodunu kontrol edin
                    if (!response.ok) {
                        throw new Error('Müşteri araması başarısız.');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Data result:", data.result);  // `result` içinde ne var onu kontrol edin

                    // API yanıtını localStorage'a kaydet
                    localStorage.setItem('customerSearchResult', JSON.stringify(data.result));

                    // customerFind.html sayfasına yönlendir
                    window.location.href = '/customerFind/';
                })
                .catch(error => {
                    console.error("Fetch error:", error);  // Hata ayrıntılarını görüntüleyin
                    alert(`Hata: ${error.message}`);
                })
                .finally(() => {
                    hideLoading(); // İşlem tamamlanınca animasyonu gizle
                });
        }

        function fetchAttributeDescriptionList(attributeTypeCode, customerCode, userName) {
            fetch(`/api/get-customer-attribute-list/${attributeTypeCode}/`)
                .then(response => response.json())
                .then(attributeList => {
                    const dropdown = document.createElement("select");
                    dropdown.classList.add("form-select", "attribute-dropdown");
                    dropdown.setAttribute("data-attribute-type", attributeTypeCode);

                    attributeList.forEach(attr => {
                        const option = document.createElement("option");
                        option.value = attr.AttributeCode;
                        option.textContent = attr.AttributeDescription;
                        dropdown.appendChild(option);
                    });

                    const cell = document.querySelector(`#dropdown-${attributeTypeCode}`);
                    cell.innerHTML = '';
                    cell.appendChild(dropdown);

                    attachUpdateListener(customerCode, userName);
                })
                .catch(error => console.error(`Attribute listesi alınırken hata oluştu: ${error.message}`));
        }

        function attachUpdateListener(customerCode, userName) {
            // Sadece ilk kez eklenmiş dropdown'lara dinleyici ekleyelim
            document.querySelectorAll(".attribute-dropdown").forEach(dropdown => {
                // Daha önce dinleyici eklenmişse tekrar ekleme
                if (!dropdown.hasAttribute('listener-added')) {
                    dropdown.addEventListener("change", (event) => {
                        const selectedOption = event.target.value;
                        const attributeTypeCode = event.target.getAttribute("data-attribute-type");

                        updateCustomerAttribute(customerCode, attributeTypeCode, selectedOption, userName);
                    });
                    // Dinleyici eklendiğini işaretle
                    dropdown.setAttribute('listener-added', 'true');
                }
            });
        }


        function updateCustomerAttribute(customerCode, attributeTypeCode, attributeCode, userName) {
            fetch('/api/add-customer-attribute/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    CustomerCode: customerCode,
                    AttributeTypeCode: attributeTypeCode,
                    AttributeCode: attributeCode,
                    username: userName
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Güncelleme başarısız.');
                }
                return response.json();
            })
            .then(data => {
                alert("Özellik başarıyla güncellendi.");
            })
            .catch(error => {
                console.error(`Hata oluştu: ${error.message}`);
            });
        }


    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
