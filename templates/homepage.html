{% extends "base.html" %}
{% load static %}

{% block title %}Anasayfa{% endblock %}

{% block extra_styles %}
        <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
{% endblock %}

{% block navbar_extra %}
    <!-- Anasayfa için navbar içine input alanı -->
    <form class="d-flex" role="search">
        <input id="search-input" class="form-control me-2" type="search" placeholder="Müşteri kodu girin" aria-label="Search">
        <button class="btn btn-outline-success" type="submit">Ara</button>
    </form>
{% endblock %}

{% block content %}
    <div id="homepage-content">
        <!-- Kutular için grid sistemi -->
        <div class="row">
            <!-- Soldaki kutu (Müşteri Bilgileri) -->
            <div class="col-lg-6">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        Müşteri Bilgileri
                    </div>
                    <div class="card-body">
                        <p id="customer-loading">Gösterilecek veri yok...</p>
                        <div id="customer-info" style="display: none;">
                            <p><strong>Adı: </strong><span id="customer-name"></span></p>
                            <p><strong>Soyadı: </strong><span id="customer-surname"></span></p>
                            <p><strong>TC Kimlik No: </strong><span id="customer-identity"></span></p>
                            <p><strong>Baba Adı: </strong><span id="customer-father"></span></p>
                            <p><strong>Anne Adı: </strong><span id="customer-mother"></span></p>
                            <p><strong>Hesap Açılış Tarihi: </strong><span id="customer-opening"></span></p>
                            <p><strong>Toplam Gecikmiş Borç: </strong><span id="customer-overdue"></span></p>
                            <p><strong>Kötü Borç: </strong><span id="customer-bad-debt"></span></p>
                            <p><strong>Kredi Limiti: </strong><span id="customer-credit"></span></p>
                            <p><strong>Kalan Limit: </strong><span id="customer-remaining"></span></p>
                            <p><strong>Hesap Durumu: </strong><span id="customer-status"></span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sağdaki kutu (Telefon Bilgileri) -->
            <div class="col-lg-6">
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <i class="fas fa-phone-alt"></i> Telefon Bilgileri
                        <button id="addPhoneBtn" class="btn btn-light btn-sm float-end" data-bs-toggle="modal" data-bs-target="#addPhoneModal" disabled>
                            <i class="fas fa-plus-circle"></i> Ekle
                        </button>
                    </div>
                    <div class="card-body">
                        <p id="phones-loading" class="text-center text-muted">Gösterilecek veri yok...</p>
                        <table id="phones-table" class="table table-hover table-striped" style="display: none;">
                            <thead class="table-dark">
                                <tr>
                                    <th>İletişim Türü</th>
                                    <th>Telefon Numarası</th>
                                </tr>
                            </thead>
                            <tbody id="phones-body">
                                <!-- Dinamik olarak doldurulacak -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation with Icons and Enhanced Styling -->
    <ul class="nav nav-tabs custom-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="installments-tab" data-bs-toggle="tab" data-bs-target="#installments" type="button" role="tab" aria-controls="installments" aria-selected="true">
                <i class="fas fa-calendar-alt me-2"></i>Taksitler
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button" role="tab" aria-controls="notes" aria-selected="false">
                <i class="fas fa-sticky-note me-2"></i>Notlar
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="messages-tab" data-bs-toggle="tab" data-bs-target="#messages" type="button" role="tab" aria-controls="messages" aria-selected="false">
                <i class="fas fa-envelope me-2"></i>Mesajlar
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="attributes-tab" data-bs-toggle="tab" data-bs-target="#attributes" type="button" role="tab" aria-controls="attributes" aria-selected="false">
                <i class="fas fa-tags me-2"></i>Özellikler
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="addresses-tab" data-bs-toggle="tab" data-bs-target="#addresses" type="button" role="tab" aria-controls="addresses" aria-selected="false">
                <i class="fas fa-map-marker-alt me-2"></i>Adresler
            </button>
        </li>
    </ul>

    <!-- Tab Content with Enhanced Styling -->
    <div class="tab-content mt-4 p-3 rounded shadow-lg bg-light" id="myTabContent">

        <!-- Taksitler Tab -->
        <div class="tab-pane fade show active" id="installments" role="tabpanel" aria-labelledby="installments-tab">
            <div class="table-responsive">
                <table class="table table-hover" id="installmentsTable">
                    <thead class="table-dark">
                        <tr>
                            <th>Tarih</th>
                            <th>Ödeme Türü</th>
                            <th>Ödeme Miktarı</th>
                        </tr>
                    </thead>
                    <tbody id="installments-body">
                        <!-- Taksit verileri burada dinamik olarak doldurulacak -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Notlar Tab -->
        <div class="tab-pane fade" id="notes" role="tabpanel" aria-labelledby="notes-tab">
            <div class="table-responsive">
                <table class="table table-hover" id="notesTable">
                    <thead class="table-dark">
                        <tr>
                            <th>Tarih</th>
                            <th>Uyarı Türü</th>
                            <th>Açıklama</th>
                            <th>Notu Alan Kişi</th>
                        </tr>
                    </thead>
                    <tbody id="notes-list">
                        <!-- Dinamik olarak doldurulacak müşteri notları burada olacak -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Mesajlar Tab -->
        <div class="tab-pane fade" id="messages" role="tabpanel" aria-labelledby="messages-tab">
            <div class="table-responsive">
                <table class="table table-hover" id="messagesTable">
                    <thead class="table-dark">
                        <tr>
                            <th>Telefon Numarası</th>
                            <th>Tarih</th>
                            <th>Mesaj</th>
                        </tr>
                    </thead>
                    <tbody id="messages-list">
                        <!-- Dinamik olarak doldurulacak müşteri mesajları burada olacak -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Özellikler Tab -->
        <div class="tab-pane fade" id="attributes" role="tabpanel" aria-labelledby="attributes-tab">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addAttributeModal">
                    <i class="fas fa-plus-circle"></i> Özellik Ekle
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Özellik Türü</th>
                            <th>Açıklama</th>
                        </tr>
                    </thead>
                    <tbody id="attributes-list">
                        <!-- Dinamik olarak doldurulacak müşteri özellikleri burada olacak -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Adresler Tab -->
        <div class="tab-pane fade" id="addresses" role="tabpanel" aria-labelledby="addresses-tab">
            <div class="table-responsive">
                <table class="table table-hover" id="addressesTable">
                    <thead class="table-dark">
                        <tr>
                            <th>Adres Türü</th>
                            <th>Adres</th>
                        </tr>
                    </thead>
                    <tbody id="addresses-list">
                        <!-- Dinamik olarak doldurulacak müşteri adresleri burada olacak -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>


   <!-- Telefon Ekleme Modülü (Bootstrap Modal) -->
    <div class="modal fade" id="addPhoneModal" tabindex="-1" aria-labelledby="addPhoneModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPhoneModalLabel">Yeni Telefon Bilgisi Ekle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body">
                    <form id="addPhoneForm">
                        <div class="mb-3">
                            <!-- İletişim Türü Dropdown -->
                            <label for="communicationType" class="form-label">İletişim Türü</label>
                            <select class="form-select" id="communicationType" required>
                                <option value="" disabled selected>İletişim türü seçin</option>
                                <option value="001">Kendi Cep Telefonu</option>
                                <option value="002">Ulaşılmasını İstediği 2. Cep Numarası</option>
                                <option value="003">İş Telefonu</option>
                                <option value="004">Ev Telefonu</option>
                                <option value="005">E-Mail</option>
                                <option value="006">Ek Kullanıcı 1 Cep Tel</option>
                                <option value="007">Ek Kullanıcı 2 Cep Tel</option>
                                <option value="008">Ek Kullanıcı 3 Cep Tel</option>
                                <option value="009">KASİYER DENEME GİRECEĞİ TEL</option>
                                <option value="010">Baba Telefonu</option>
                                <option value="011">Anne Telefonu</option>
                                <option value="012">Eşinin Telefonu</option>
                                <option value="013">Arkadaş Telefonu</option>
                                <option value="014">Kardeş (Aile Bireyi)</option>
                                <option value="015">İsimli Tel. Alma</option>
                                <option value="016">Kızı</option>
                                <option value="017">Oğlu</option>
                                <option value="018">Yakın Akrabası</option>
                                <option value="019">Tanıdığı</option>
                                <option value="020">Kullanım Dışı</option>
                                <option value="021">Başkası Tarafından Kullanılıyor</option>
                                <option value="022">Güncel Olabilecek Telefonu</option>
                                <option value="023">Yeni Güncel Güncel Telefonu Olabilir</option>
                                <option value="024">Avukata Gelen Kendi Telefon Numarası</option>
                                <option value="025">Avukata Gelen Akraba ve Yakını Telefonu</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <!-- Telefon Numarası -->
                            <label for="phoneNumber" class="form-label">Telefon Numarası</label>
                            <input type="text" class="form-control" id="phoneNumber" placeholder="Telefon numarası girin" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Kaydet</button>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Özellik Ekleme Modülü (Bootstrap Modal) -->
    <div class="modal fade" id="addAttributeModal" tabindex="-1" aria-labelledby="addAttributeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addAttributeModalLabel">Yeni Özellik Ekle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addAttributeForm">
                        <div class="mb-3">
                            <label for="attributeType" class="form-label">Özellik Türü</label>
                            <select class="form-select" id="attributeType" required>
                                <option selected disabled>Özellik türü seçin...</option>
                                <!-- Dinamik olarak doldurulacak -->
                            </select>
                        </div>

                        <!-- Dinamik olarak gelen veriler (Attribute listesi) -->
                        <div id="dynamicAttributeSection" class="mb-3" style="display:none;">
                            <label for="dynamicAttributeSelect" class="form-label">Özellik Seçin</label>
                            <select class="form-select" id="dynamicAttributeSelect" required>
                                <option selected disabled>Özellik seçin...</option>
                                <!-- API'den gelen seçenekler buraya eklenecek -->
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary">Kaydet</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification (Uyarı Mesajı) -->
    <div id="toast-notification" class="toast align-items-center text-bg-success border-0 position-fixed top-0 end-0 m-3" style="display: none; z-index: 1050;">
        <div class="d-flex">
            <div class="toast-body">
                Arama başlatıldı!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Kapat" onclick="closeToast()"></button>
        </div>
    </div>

    <!-- Modal Trigger -->
    <button type="button" class="btn btn-primary d-none" id="trigger-modal" data-bs-toggle="modal" data-bs-target="#searchModal">Aç</button>

    <!-- Ana Sayfa Modal Yapısı -->
    <div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="card shadow-lg border-0 rounded-3">
                    <div class="card-header bg-primary text-white text-center rounded-top">
                        <h1 class="h3 mb-0">Arama Sonucu</h1>
                    </div>
                    <div class="card-body px-5">
                        <!-- Telefon Bilgisi -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" id="phone" class="form-control fw-bold bg-light text-dark" value="">
                                    <label for="phone" class="form-label"><strong>Telefon Numarası</strong></label>
                                </div>
                            </div>
                        </div>
    
                        <!-- Customer Code Input -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" id="customer-code" class="form-control" placeholder="Müşteri kodunu girin">
                                    <label for="customer-code"><strong>Müşteri Kodu</strong></label>
                                </div>
                            </div>
                        </div>
    
                        <!-- Kategori Radio Button Menüsü -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <h5 class="text-muted">Konu Seçiniz:</h5>
                                <div id="category-container" class="row row-cols-1 row-cols-md-3 g-3 overflow-auto" style="max-height: 300px;">
                                    <p>Yükleniyor...</p>
                                </div>
                            </div>
                        </div>
    
                        <!-- Not Ekleme Alanı -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="form-floating">
                                    <textarea id="user-note" class="form-control" rows="4" placeholder="Ek açıklama girin..."></textarea>
                                    <label for="user-note"><strong>Not Ekle</strong></label>
                                </div>
                            </div>
                        </div>
    
                        <!-- İşlemi Onayla ve Not Kaydet Butonları -->
                        <div class="text-center">
                            <button id="save-note-btn" class="btn btn-success btn-lg px-5 py-3 shadow-sm">
                                <i class="fas fa-check-circle"></i> İşlemi Onayla ve Notu Kaydet
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Optional Custom CSS for Styling -->
    <style>
        /* General Settings */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f4f6f8;
            transition: background-color 0.3s ease;
        }

        /* Navbar Search */
        .form-control {
            border-radius: 20px;
            transition: box-shadow 0.3s ease;
        }

        .form-control:focus {
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            border-color: #3b82f6;
        }

        .btn-outline-success {
            color: #2563eb;
            border-color: #2563eb;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .btn-outline-success:hover {
            background-color: #2563eb;
            color: #fff;
            box-shadow: 0 5px 10px rgba(37, 99, 235, 0.3);
        }

        /* Card Styling */
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            font-weight: 600;
            font-size: 1.2rem;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #ffffff;
            border-radius: 15px 15px 0 0;
        }

        /* Table Headings */
        .table-dark {
            background-color: #1f2937;
            color: #ffffff;
            font-size: 0.95rem;
        }

        .table-hover tbody tr:hover {
            background-color: #e9ecef;
            transition: background-color 0.3s ease;
        }

        /* Custom Tabs Styling */
        .custom-tabs .nav-link {
            color: #6b7280;
            font-weight: 500;
            font-size: 1rem;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            transition: color 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .custom-tabs .nav-link i {
            font-size: 1.2rem;
            margin-right: 8px;
        }

        .custom-tabs .nav-link.active {
            color: #ffffff;
            background-color: #3b82f6;
            border-color: #3b82f6;
            box-shadow: 0px 4px 10px rgba(59, 130, 246, 0.3);
        }

        .custom-tabs .nav-link:hover {
            background-color: #e5e7eb;
            color: #1f2937;
            box-shadow: 0px 3px 6px rgba(0, 0, 0, 0.1);
        }

        /* Tab Content */
        .tab-content {
            background-color: #ffffff;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0px 5px 20px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s ease;
        }

        .tab-content:hover {
            box-shadow: 0px 8px 25px rgba(0, 0, 0, 0.15);
        }

        /* Buttons */
        .btn-primary, .btn-outline-primary {
            border-radius: 12px;
            font-weight: 500;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .btn-primary:hover, .btn-outline-primary:hover {
            box-shadow: 0px 5px 15px rgba(0, 123, 255, 0.3);
        }

        /* Modals */
        .modal-content {
            border-radius: 15px;
            border: none;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease;
        }

        .modal-content:hover {
            transform: scale(1.02);
        }

        .modal-header {
            background-color: #1f2937;
            color: #ffffff;
            border-bottom: none;
            border-radius: 15px 15px 0 0;
        }

        /* Toast Notification */
        .toast {
            background-color: #1f2937;
            color: #ffffff;
            font-weight: 500;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
            transition: opacity 0.5s ease;
        }

        .toast-body {
            font-size: 1rem;
        }

        .toast .btn-close {
            filter: brightness(80%);
        }

        /* Improved Spacing */
        .card-body p, .modal-body p, .table th, .table td {
            margin-bottom: 10px;
        }

        /* Responsive Improvements */
        @media (max-width: 768px) {
            .custom-tabs .nav-link {
                font-size: 0.85rem;
                padding: 0.5rem 0.75rem;
            }
        }
    </style>
    
{% endblock %}

{% block extra_scripts %}
    <script src="{% static 'js/homepage.js' %}"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const phone = "05515565825";
            document.getElementById('phone').value = phone;
            fetchCategories();
    
            // Notu kaydet butonuna tıklandığında veriyi işle ve gönder
            document.getElementById('save-note-btn').addEventListener('click', function () {
                saveNote();
            });
    
            // Firebase ile veri dinleyici
            const firebaseConfig = {
                apiKey: "API_KEY",
                authDomain: "PROJECT_ID.firebaseapp.com",
                databaseURL: "https://PROJECT_ID.firebaseio.com",
                projectId: "PROJECT_ID",
                storageBucket: "PROJECT_ID.appspot.com",
                messagingSenderId: "SENDER_ID",
                appId: "APP_ID"
            };
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
    
            database.ref('path/to/your/data').on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    document.getElementById('phone').value = data.phone || '';
                    document.getElementById('customer-code').value = data.customerCode || '';
                    
                    // Modalı aç
                    $('#searchModal').modal('show');
                }
            });
        });
    
        function fetchCategories() {
            const categoryContainer = document.getElementById('category-container');
            categoryContainer.innerHTML = '<p>Yükleniyor...</p>';
    
            fetch('/api/get-customer-note-categories/')
                .then(response => response.json())
                .then(data => {
                    categoryContainer.innerHTML = '';
                    if (data.length === 0) {
                        categoryContainer.innerHTML = '<p>Hiç kategori bulunamadı</p>';
                        return;
                    }
                    data.forEach(item => {
                        const radioWrapper = document.createElement('div');
                        radioWrapper.classList.add('form-check', 'col');
                        const radioInput = document.createElement('input');
                        radioInput.classList.add('form-check-input');
                        radioInput.type = 'radio';
                        radioInput.name = 'category';
                        radioInput.id = `category-${item.UserWarningCode}`;
                        radioInput.value = item.UserWarningCode;
                        radioInput.dataset.description = item.UserWarningDescription;
    
                        const radioLabel = document.createElement('label');
                        radioLabel.classList.add('form-check-label');
                        radioLabel.htmlFor = `category-${item.UserWarningCode}`;
                        radioLabel.textContent = item.UserWarningDescription;
    
                        radioWrapper.appendChild(radioInput);
                        radioWrapper.appendChild(radioLabel);
                        categoryContainer.appendChild(radioWrapper);
                    });
                })
                .catch(error => {
                    console.error('Kategori yüklenirken hata oluştu:', error);
                    categoryContainer.innerHTML = '<p>Veri Yüklenemedi</p>';
                });
        }
    
        function saveNote() {
            const customerCode = document.getElementById('customer-code').value;
            const selectedCategory = document.querySelector('input[name="category"]:checked');
            const noteText = document.getElementById('user-note').value;
            const phoneNumber = document.getElementById('phone').value;
            const username = "{{ username }}";
    
            if (!customerCode || !selectedCategory || !noteText.trim()) {
                alert('Lütfen tüm alanları doldurunuz!');
                return;
            }
    
            const data = {
                CustomerCode: customerCode,
                UserWarningCode: selectedCategory.value,
                CommAddress: phoneNumber,
                Description: noteText,
                UserWarningDescription: selectedCategory.dataset.description,
                username: username
            };
    
            fetch('/api/add_customer_note', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.procedure_info) {
                    alert('Veriler başarıyla gönderildi.');
                } else {
                    alert('Veri gönderilirken bir hata oluştu.');
                }
            })
            .catch(error => {
                console.error('Veri gönderilirken bir hata oluştu:', error);
            });
        }
    
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>

{% endblock %}
