{% extends "base.html" %}
{% load static %}

{% block title %}Arama Sonucu{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white text-center">
            <h1>Arama Sonucu</h1>
        </div>
        <div class="card-body">
            <!-- Telefon Numarası Girişi -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="alert alert-info">
                        <p><strong>Telefon Numarası:</strong></p>
                        <input type="text" id="phone-number" class="form-control fw-bold" placeholder="Telefon numarasını girin">
                    </div>
                </div>
            </div>

            <!-- Kategori Radio Button Menüsü -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <h5>Konu Seçiniz:</h5>
                    <div id="category-container" class="radio-input row row-cols-1 row-cols-md-3 g-3" style="max-height: 300px; overflow-y: auto;">
                        <p>Yükleniyor...</p>
                    </div>
                </div>
            </div>

            <!-- Not Ekleme Alanı -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <h5>Not Ekle:</h5>
                    <textarea id="user-note" class="form-control" rows="4" placeholder="Notunuzu buraya yazın..."></textarea>
                </div>
            </div>

            <!-- İşlemi Onayla ve Not Kaydet Butonları -->
            <div class="text-center">
                <button id="save-note-btn" class="btn btn-success btn-lg px-4">
                    <i class="fas fa-check-circle"></i> İşlemi Onayla ve Notu Kaydet
                </button>
            </div>

            <!-- Seçili Kategori Kodu (Gizli veya açıklama için gösterilebilir) -->
            <div class="alert alert-secondary mt-4">
                <p><strong>Seçili Konu Kodu:</strong> <span id="selected-category-code" class="fw-bold">Seçilmedi</span></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<style>
/* Custom Radio Button Style */
.input {
  -webkit-appearance: none;
  display: block;
  margin: 10px;
  width: 24px;
  height: 24px;
  border-radius: 12px;
  cursor: pointer;
  vertical-align: middle;
  box-shadow: hsla(0, 0%, 100%, .15) 0 1px 1px, inset hsla(0, 0%, 0%, .5) 0 0 0 1px;
  background-color: hsla(0, 0%, 0%, .2);
  background-image: -webkit-radial-gradient(hsla(200, 100%, 90%, 1) 0%, hsla(200, 100%, 70%, 1) 15%, hsla(200, 100%, 60%, .3) 28%, hsla(200, 100%, 30%, 0) 70%);
  background-repeat: no-repeat;
  -webkit-transition: background-position .15s cubic-bezier(.8, 0, 1, 1), -webkit-transform .25s cubic-bezier(.8, 0, 1, 1);
  outline: none;
}

.input:checked {
  -webkit-transition: background-position .2s .15s cubic-bezier(0, 0, .2, 1), -webkit-transform .25s cubic-bezier(0, 0, .2, 1);
}

.input:active {
  -webkit-transform: scale(1.5);
  -webkit-transition: -webkit-transform .1s cubic-bezier(0, 0, .2, 1);
}

.input,
.input:active {
  background-position: 0 24px;
}

.input:checked {
  background-position: 0 0;
}

.input:checked ~ .input,
.input:checked ~ .input:active {
  background-position: 0 -24px;
}
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        const phoneNumber = urlParams.get('phone_number');
        const phoneNumberInput = document.getElementById('phone-number');

        if (phoneNumber) {
            phoneNumberInput.value = phoneNumber;
            phoneNumberInput.readOnly = true;
        }

        fetchCategories();

        const categoryContainer = document.getElementById('category-container');
        categoryContainer.addEventListener('change', function () {
            const selectedRadio = document.querySelector('input[name="category"]:checked');
            document.getElementById('selected-category-code').innerText = selectedRadio ? selectedRadio.value : 'Seçilmedi';
        });

        document.getElementById('save-note-btn').addEventListener('click', function () {
            saveNote();
        });
    });

    function fetchCategories() {
        const categoryContainer = document.getElementById('category-container');
        categoryContainer.innerHTML = '<p>Yükleniyor...</p>';

        fetch('/api/get-customer-note-categories/')
            .then(response => response.json())
            .then(data => {
                categoryContainer.innerHTML = '';
                if (data.length === 0) {
                    categoryContainer.innerHTML = '<p>Hiç kategori bulunamadı</p>';
                    return;
                }

                data.forEach(item => {
                    const radioInput = document.createElement('input');
                    radioInput.classList.add('input');
                    radioInput.type = 'radio';
                    radioInput.name = 'category';
                    radioInput.id = `category-${item.UserWarningCode}`;
                    radioInput.value = item.UserWarningCode;

                    const label = document.createElement('label');
                    label.classList.add('ms-2');
                    label.htmlFor = `category-${item.UserWarningCode}`;
                    label.textContent = item.UserWarningDescription;

                    const wrapper = document.createElement('div');
                    wrapper.classList.add('d-flex', 'align-items-center');
                    wrapper.appendChild(radioInput);
                    wrapper.appendChild(label);

                    categoryContainer.appendChild(wrapper);
                });
            })
            .catch(error => {
                console.error('Kategori yüklenirken hata oluştu:', error);
                categoryContainer.innerHTML = '<p>Veri Yüklenemedi</p>';
            });
    }

    function saveNote() {
        const selectedCategory = document.querySelector('input[name="category"]:checked');
        const noteText = document.getElementById('user-note').value;
        const phoneNumber = document.getElementById('phone-number').value;

        if (!phoneNumber) {
            alert('Lütfen telefon numarasını girin!');
            return;
        }

        if (!selectedCategory) {
            alert('Lütfen bir kategori seçin!');
            return;
        }

        if (!noteText.trim()) {
            alert('Lütfen bir not yazın!');
            return;
        }

        const data = {
            phone_number: phoneNumber,
            category_code: selectedCategory.value,
            note: noteText
        };

        fetch('/api/save-note/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('Not başarıyla kaydedildi!');
                document.getElementById('user-note').value = '';
            } else {
                alert('Not kaydedilirken bir hata oluştu.');
            }
        })
        .catch(error => {
            console.error('Not kaydedilirken bir hata oluştu:', error);
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
