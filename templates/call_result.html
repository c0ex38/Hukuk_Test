{% extends "base.html" %}
{% load static %}

{% block title %}Arama Sonucu{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow-lg border-0 rounded-3">
        <div class="card-header bg-primary text-white text-center rounded-top">
            <h1 class="h3 mb-0">Arama Sonucu</h1>
        </div>
        <div class="card-body px-5">
            <!-- Telefon Bilgisi -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="form-floating">
                        <input type="text" id="phone" class="form-control fw-bold bg-light text-dark" value="">
                        <label for="phone" class="form-label"><strong>Telefon Numarası</strong></label>
                    </div>
                </div>
            </div>

            <!-- Customer Code Input -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="form-floating">
                        <input type="text" id="customer-code" class="form-control" placeholder="Müşteri kodunu girin">
                        <label for="customer-code"><strong>Müşteri Kodu</strong></label>
                    </div>
                </div>
            </div>

            <!-- Kategori Radio Button Menüsü -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <h5 class="text-muted">Konu Seçiniz:</h5>
                    <div id="category-container" class="row row-cols-1 row-cols-md-3 g-3 overflow-auto" style="max-height: 300px;">
                        <p>Yükleniyor...</p>
                    </div>
                </div>
            </div>

            <!-- Not Ekleme Alanı -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="form-floating">
                        <textarea id="user-note" class="form-control" rows="4" placeholder="Ek açıklama girin..."></textarea>
                        <label for="user-note"><strong>Not Ekle</strong></label>
                    </div>
                </div>
            </div>

            <!-- İşlemi Onayla ve Not Kaydet Butonları -->
            <div class="text-center">
                <button id="save-note-btn" class="btn btn-success btn-lg px-5 py-3 shadow-sm">
                    <i class="fas fa-check-circle"></i> İşlemi Onayla ve Notu Kaydet
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_styles %}
<style>
    .form-floating>.form-control,
    .form-floating>.form-select {
        height: calc(3.5rem + 2px);
        padding: 1rem 0.75rem;
    }

    #category-container .form-check-input {
        width: 1.5em;
        height: 1.5em;
    }

    #category-container .form-check-label {
        font-weight: 500;
        font-size: 0.95rem;
    }

    #save-note-btn {
        transition: background-color 0.3s, transform 0.3s;
    }

    #save-note-btn:hover {
        background-color: #218838;
        transform: translateY(-2px);
    }

    .card {
        border-radius: 1rem;
    }

    .card-header {
        border-top-left-radius: 1rem;
        border-top-right-radius: 1rem;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const phone = "05515565825";  // Burada telefon numarasını sabit değer olarak varsaydık
        document.getElementById('phone').value = phone; // Sayfada göster

        fetchCategories(); // Kategorileri yükle

        // Notu kaydet butonuna tıklandığında veriyi işle ve gönder
        document.getElementById('save-note-btn').addEventListener('click', function () {
            saveNote();
        });
    });

    // Kategorileri al ve radio button olarak göster
    function fetchCategories() {
        const categoryContainer = document.getElementById('category-container');
        categoryContainer.innerHTML = '<p>Yükleniyor...</p>';

        fetch('/api/get-customer-note-categories/')
            .then(response => response.json())
            .then(data => {
                categoryContainer.innerHTML = '';  // Var olan içeriği temizle

                if (data.length === 0) {
                    categoryContainer.innerHTML = '<p>Hiç kategori bulunamadı</p>';
                    return;
                }

                data.forEach(item => {
                    const radioWrapper = document.createElement('div');
                    radioWrapper.classList.add('form-check', 'col');

                    const radioInput = document.createElement('input');
                    radioInput.classList.add('form-check-input');
                    radioInput.type = 'radio';
                    radioInput.name = 'category';
                    radioInput.id = `category-${item.UserWarningCode}`;
                    radioInput.value = item.UserWarningCode;
                    radioInput.dataset.description = item.UserWarningDescription;

                    const radioLabel = document.createElement('label');
                    radioLabel.classList.add('form-check-label');
                    radioLabel.htmlFor = `category-${item.UserWarningCode}`;
                    radioLabel.textContent = item.UserWarningDescription;

                    radioWrapper.appendChild(radioInput);
                    radioWrapper.appendChild(radioLabel);
                    categoryContainer.appendChild(radioWrapper);
                });
            })
            .catch(error => {
                console.error('Kategori yüklenirken hata oluştu:', error);
                categoryContainer.innerHTML = '<p>Veri Yüklenemedi</p>';
            });
    }

    // Notu kaydetme fonksiyonu
    function saveNote() {
        const customerCode = document.getElementById('customer-code').value;
        const selectedCategory = document.querySelector('input[name="category"]:checked');
        const noteText = document.getElementById('user-note').value;
        const phoneNumber = document.getElementById('phone').value;
        const username = "{{ username }}";  // Django'dan gelen kullanıcı adı

        if (!customerCode) {
            alert('Müşteri kodunu giriniz!');
            return;
        }

        if (!selectedCategory) {
            alert('Lütfen bir kategori seçin!');
            return;
        }

        if (!noteText.trim()) {
            alert('Lütfen bir not yazın!');
            return;
        }

        // Description içeriğini oluştur
        const description = `Görüşülen tel no: ${phoneNumber}, Kategori: ${selectedCategory.dataset.description}, Not: ${noteText}, Kullanıcı: ${username}`;

        const data = {
            CustomerCode: customerCode,
            UserWarningCode: selectedCategory.value,
            CommAddress: phoneNumber,  // Telefon numarası
            Description: noteText,  // Kullanıcının yazdığı not
            UserWarningDescription: selectedCategory.dataset.description,
            username: username
        };

        // Notu kaydetmek için API isteği gönder
        fetch('/api/add_customer_note', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')  // CSRF koruması
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.procedure_info) {
                console.log('Gönderilen Veriler:', result.procedure_info);
                alert('Veriler başarıyla gönderildi. Detaylar konsolda.');
            } else {
                alert('Veri gönderilirken bir hata oluştu.');
            }
        })
        .catch(error => {
            console.error('Veri gönderilirken bir hata oluştu:', error);
        });
    }

    // CSRF token'ı almak için yardımcı fonksiyon
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
